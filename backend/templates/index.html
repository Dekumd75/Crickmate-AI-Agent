<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrickMate AI Coach</title>
    <style>
        :root { 
            --primary: #008000; /* Cricket Green */
            --primary-dark: #006400; 
            --bg: #e5ddd5; /* WhatsApp-like background */
            --chat-bg: #ffffff;
            --user-msg-bg: #dcf8c6; /* Classic Chat App Green */
            --bot-msg-bg: #ffffff;
            --shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #d1d7db; 
            display: flex; 
            justify-content: center; 
            height: 100vh; 
            margin: 0; 
        }

        /* --- MODERN MODAL (Login) --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal h2 { color: var(--primary); margin-top: 0; font-size: 24px; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 13px; margin-bottom: 5px; color: #666; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: 0.3s; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); outline: none; }
        .start-btn { width: 100%; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
        .start-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }

        /* --- MAIN CHAT CONTAINER --- */
        .chat-container { 
            width: 100%; 
            max-width: 500px; 
            background: #efe7dd; /* Chat Pattern Background color */
            display: none; 
            flex-direction: column; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); 
            height: 100%; 
            position: relative;
        }

        @media (min-width: 600px) {
            .chat-container { height: 95vh; margin-top: 2.5vh; border-radius: 20px; overflow: hidden; }
        }

        /* --- HEADER --- */
        .header { 
            background: #075e54; /* Professional Dark Green */
            color: white; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .header-title { font-weight: bold; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .user-badge { font-size: 11px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; }

        /* --- CHAT AREA --- */
        .chat-box { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); /* WhatsApp Doodle Pattern */
            background-blend-mode: soft-light;
        }

        /* --- BUBBLES --- */
        .message { 
            max-width: 80%; 
            padding: 10px 14px; 
            border-radius: 8px; 
            font-size: 15px; 
            line-height: 1.4; 
            position: relative; 
            box-shadow: var(--shadow);
            word-wrap: break-word;
        }

        /* Bot Bubble */
        .bot-message { 
            background: white; 
            color: #333; 
            align-self: flex-start; 
            border-top-left-radius: 0; 
        }
        .bot-message::after {
            content: ""; position: absolute; left: -10px; top: 0;
            width: 0; height: 0;
            border: 10px solid transparent; border-top-color: white; border-right: 0; margin-top: 0; margin-right: -10px;
        }

        /* User Bubble */
        .user-message { 
            background: var(--user-msg-bg); 
            color: #303030; 
            align-self: flex-end; 
            border-top-right-radius: 0; 
        }
        .user-message::after {
            content: ""; position: absolute; right: -10px; top: 0;
            width: 0; height: 0;
            border: 10px solid transparent; border-top-color: var(--user-msg-bg); border-left: 0; margin-top: 0; margin-left: -10px;
        }

        /* --- CARDS & LISTS INSIDE CHAT --- */
        .drill-card { background: rgba(0,0,0,0.03); padding: 10px; margin-top: 5px; border-radius: 5px; border-left: 4px solid var(--primary); }
        h4 { margin: 0 0 8px 0; color: #075e54; font-size: 14px; }
        ul { margin: 0; padding-left: 20px; }
        li { margin-bottom: 4px; font-size: 14px; }
        .highlight { color: #d32f2f; font-weight: bold; }

        /* --- INPUT AREA --- */
        .input-area { 
            padding: 10px; 
            background: #f0f0f0; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        input.chat-input { 
            flex: 1; 
            padding: 12px 15px; 
            border: none; 
            border-radius: 25px; 
            outline: none; 
            font-size: 16px; 
            background: white;
        }
        button.send-btn { 
            background: #075e54; 
            color: white; 
            border: none; 
            width: 45px; height: 45px; 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        button.send-btn:hover { background: #128c7e; transform: scale(1.05); }

        /* --- TYPING INDICATOR (Jumping Dots) --- */
        .typing { 
            align-self: flex-start; 
            background: white; 
            padding: 10px 15px; 
            border-radius: 20px; 
            border-bottom-left-radius: 0;
            margin-bottom: 10px; 
            display: none; 
            width: fit-content;
            box-shadow: var(--shadow);
        }
        .dot {
            height: 8px; width: 8px; 
            background-color: #bbb; 
            border-radius: 50%; 
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>üèè Player Profile</h2>
            
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="regName" placeholder="Enter your name" value="Champ">
            </div>
            
            <div class="form-group" style="display:flex; gap:15px;">
                <div style="flex: 1;">
                    <label>Age</label>
                    <input type="number" id="regAge" placeholder="20" value="20">
                </div>
                <div style="flex: 1;">
                    <label>Height (cm)</label>
                    <input type="number" id="regHeight" placeholder="175" value="175">
                </div>
            </div>

            <div class="form-group">
                <label>Weight (kg)</label>
                <input type="number" id="regWeight" placeholder="70" value="70">
            </div>

            <div class="form-group">
                <label>Playing Role</label>
                <select id="regRole">
                    <option value="top order batsman">Top Order Batsman</option>
                    <option value="middle order batsman">Middle Order Batsman</option>
                    <option value="finisher">Finisher</option>
                    <option value="wicket keeper batsman">Wicket Keeper Batsman</option>
                    <option value="fast bowler">Fast Bowler</option>
                    <option value="medium bowler">Medium Bowler</option>
                    <option value="wrist spinner">Wrist Spinner</option>
                    <option value="finger spinner">Finger Spinner</option>
                    <option value="all rounder">All Rounder</option>
                </select>
            </div>

            <div class="form-group">
                <label>Current Skill Level</label>
                <select id="regSkill">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                </select>
            </div>

            <button class="start-btn" onclick="registerUser()">Start Coaching</button>
            <p id="regError" style="color:red; display:none; font-size:12px; margin-top:10px;"></p>
        </div>

    <div class="chat-container" id="chatContainer">
        <div class="header">
            <span>üèè CrickMate AI</span>
            <span class="user-badge" id="userBadge">Guest</span>
        </div>
        <div class="chat-box" id="chatBox">
            <div class="message bot-message">
                Hi! I'm your AI Coach. I see your profile. How can I help you improve today?
            </div>
        </div>
        <div class="typing" id="typingIndicator">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
        <div class="input-area">
            <input type="text" id="userInput" class="chat-input" placeholder="Type here..." onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <script>
        const API_BASE = "/api";
        let CURRENT_USER_ID = null;

        // --- 1. REGISTRATION LOGIC ---
        async function registerUser() {
            const btn = document.querySelector('.start-btn');
            const err = document.getElementById('regError');
            
            const userData = {
                name: document.getElementById('regName').value,
                age: parseInt(document.getElementById('regAge').value),
                weight_kg: parseInt(document.getElementById('regWeight').value),
                height_cm: parseInt(document.getElementById('regHeight').value),
                playing_role: document.getElementById('regRole').value,
                skill_level: document.getElementById('regSkill').value,
                weekly_days: 3
            };

            btn.textContent = "Creating Profile...";
            btn.disabled = true;
            err.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/register-user`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(userData)
                });
                const data = await response.json();

                if (data.status === "success") {
                    CURRENT_USER_ID = data.user_id;
                    let displayRole = userData.playing_role.charAt(0).toUpperCase() + userData.playing_role.slice(1);
                    document.getElementById('userBadge').textContent = `${userData.name} (${displayRole})`;
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('chatContainer').style.display = 'flex';
                } else {
                    err.textContent = "Error: " + data.message;
                    err.style.display = 'block';
                    btn.disabled = false;
                    btn.textContent = "Start Coaching";
                }
            } catch (error) {
                console.error(error);
                err.textContent = "Server error. Is python app.py running?";
                err.style.display = 'block';
                btn.disabled = false;
                btn.textContent = "Start Coaching";
            }
        }

        // --- 2. CHAT LOGIC ---
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        async function sendMessage() {
            const inputField = document.getElementById("userInput");
            const message = inputField.value.trim();
            if (!message) return;

            addMessage(message, 'user-message');
            inputField.value = "";
            document.getElementById("typingIndicator").style.display = "block";

            try {
                const response = await fetch(`${API_BASE}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: CURRENT_USER_ID, message: message })
                });
                const data = await response.json();
                document.getElementById("typingIndicator").style.display = "none";

                let botHTML = "";
                
                if (data.chat) botHTML += `<p>${data.chat.replace(/\n/g, "<br>")}</p>`;

                // FIXED: CASE A - Direct Category Selection (e.g., Typing "A")
                if (data.type === "technical_category" && data.sub_areas) {
                    botHTML += `<div class="drill-card">`;
                    if (data.category_name) botHTML += `<h4>üìÇ ${data.category_name}</h4>`;
                    botHTML += `<strong>Options:</strong><ul>`;
                    data.sub_areas.forEach(sub => botHTML += renderListItem(sub));
                    botHTML += `</ul></div>`;
                }

                // CASE B: Shortcuts (Drills)
                if (data.technical_drills && data.technical_drills.returned) {
                    botHTML += `<div class="drill-card"><h4>üéØ Drills</h4><ul>`;
                    data.technical_drills.returned.forEach(drill => botHTML += renderListItem(drill));
                    botHTML += `</ul>`;
                    if (data.technical_drills.remaining > 0) {
                        botHTML += `<div class="more-hint">üëá ${data.technical_drills.remaining} more available. Type "more".</div>`;
                    }
                    botHTML += `</div>`;
                }

                // CASE C: Standard Lists (Priority, Drills, Plans)
                if (data.ordered_responses && data.ordered_responses.length > 0) {
                    data.ordered_responses.forEach(item => {
                        botHTML += `<div class="drill-card">`;
                        
                        if (item.type === "batting_role_priority") {
                             if(item.priority && item.priority.length > 0) {
                                 botHTML += `<h4>üî• High Priority</h4><ul>`;
                                 item.priority.forEach(p => botHTML += renderListItem(p));
                                 botHTML += `</ul>`;
                             }
                             if(item.secondary && item.secondary.length > 0) {
                                 botHTML += `<h4>‚ö†Ô∏è Secondary Focus</h4><ul>`;
                                 item.secondary.forEach(p => botHTML += renderListItem(p));
                                 botHTML += `</ul>`;
                             }
                             if(item.low && item.low.length > 0) {
                                 botHTML += `<h4>‚úÖ Low Priority / Maintain</h4><ul>`;
                                 item.low.forEach(p => botHTML += renderListItem(p));
                                 botHTML += `</ul>`;
                             }
                        }
                        else if (item.sub_areas) {
                            botHTML += `<strong>Options:</strong><ul>`;
                            item.sub_areas.forEach(sub => botHTML += renderListItem(sub));
                            botHTML += `</ul>`;
                        }
                        else if (item.result && typeof item.result === 'object') {
                            if (item.result.name) botHTML += `<h4>üéØ ${item.result.name}</h4>`;
                            if (item.result.goal) botHTML += `<em>Goal: ${item.result.goal}</em><hr>`;

                            Object.keys(item.result).forEach(key => {
                                if (Array.isArray(item.result[key]) && item.result[key].length > 0) {
                                    let title = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, " ");
                                    botHTML += `<strong>${title}:</strong><ul>`;
                                    item.result[key].forEach(li => botHTML += renderListItem(li));
                                    botHTML += `</ul>`;
                                }
                            });
                        } 
                        else if (typeof item.result === 'string') {
                            botHTML += `<p>${item.result}</p>`;
                        }
                        botHTML += `</div>`;
                    });
                }

                addMessage(botHTML, 'bot-message', true);

            } catch (error) {
                console.error(error);
                document.getElementById("typingIndicator").style.display = "none";
                addMessage(`System Error: ${error.message}`, 'message error-message');
            }
        }

        // --- 3. SMART RENDERER ---
        function renderListItem(item) {
            // String (simple text)
            if (typeof item === 'string') return `<li>${item}</li>`;
            
            // Object with ID/Name (Priority List & Sub Areas)
            if (item.id && item.name) return `<li><span class="highlight">${item.id}:</span> ${item.name}</li>`;
            
            // Complex Object (Full Drill)
            let html = `<li>`;
            Object.keys(item).forEach(key => {
                let val = item[key];
                let label = key.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
                html += `<span class="label">${label}:</span> ${val} <br>`; 
            });
            html += `</li>`;
            return html;
        }

        function addMessage(text, className, isHTML = false) {
            const chatBox = document.getElementById("chatBox");
            const div = document.createElement("div");
            div.className = `message ${className}`;
            if (isHTML) div.innerHTML = text;
            else div.textContent = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>